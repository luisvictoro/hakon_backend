#!/usr/bin/env python3
"""
Script para testar endpoints de vulnerabilidade
"""

import requests
import json

# URL do backend
BASE_URL = "https://hakon-56ae06ddc8d1.herokuapp.com"

def get_auth_token():
    """Obter token de autenticaÃ§Ã£o"""
    login_data = {
        "username": "admin",
        "password": "admin"
    }
    
    try:
        response = requests.post(
            f"{BASE_URL}/api/auth/login",
            json=login_data,
            timeout=10
        )
        
        if response.status_code == 200:
            token_data = response.json()
            return token_data.get("access_token")
        else:
            print(f"âŒ Erro no login: {response.status_code}")
            return None
            
    except Exception as e:
        print(f"âŒ Erro ao obter token: {e}")
        return None

def test_endpoint_with_auth(endpoint, token):
    """Testar endpoint com autenticaÃ§Ã£o"""
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    try:
        response = requests.get(f"{BASE_URL}{endpoint}", headers=headers, timeout=10)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 200:
            print("   âœ… Sucesso!")
            data = response.json()
            if isinstance(data, list):
                print(f"   ğŸ“Š Retornou {len(data)} itens")
            else:
                print(f"   ğŸ“Š Resposta: {json.dumps(data, indent=2)}")
        else:
            print(f"   âŒ Erro: {response.text}")
            
    except Exception as e:
        print(f"   âŒ Erro: {e}")

def test_endpoint_without_auth(endpoint):
    """Testar endpoint sem autenticaÃ§Ã£o"""
    try:
        response = requests.get(f"{BASE_URL}{endpoint}", timeout=10)
        print(f"   Status: {response.status_code}")
        
        if response.status_code == 401:
            print("   âš ï¸  Requer autenticaÃ§Ã£o (esperado)")
        elif response.status_code == 200:
            print("   âœ… Funcionou sem autenticaÃ§Ã£o")
        else:
            print(f"   âŒ Erro: {response.text}")
            
    except Exception as e:
        print(f"   âŒ Erro: {e}")

def main():
    """Testar todos os endpoints"""
    
    print("=== Testando Endpoints de Vulnerabilidade ===")
    print(f"Base URL: {BASE_URL}")
    print()
    
    # Obter token de autenticaÃ§Ã£o
    print("1. Obtendo token de autenticaÃ§Ã£o...")
    token = get_auth_token()
    
    if not token:
        print("âŒ NÃ£o foi possÃ­vel obter token. Testando sem autenticaÃ§Ã£o...")
        token = None
    
    print(f"   Token: {token[:20] if token else 'Nenhum'}...")
    print()
    
    # Lista de endpoints para testar
    endpoints = [
        "/api/vulnerability/months",
        "/api/vulnerability/uploads", 
        "/api/vulnerability/list",
        "/api/vulnerability/upload"
    ]
    
    for endpoint in endpoints:
        print(f"2. Testando {endpoint}...")
        
        if token:
            test_endpoint_with_auth(endpoint, token)
        else:
            test_endpoint_without_auth(endpoint)
        
        print()
    
    print("=== Resumo ===")
    print("Endpoints disponÃ­veis:")
    print("âœ… /api/vulnerability/months - Lista meses")
    print("âœ… /api/vulnerability/uploads - Lista vulnerabilidades")
    print("âœ… /api/vulnerability/list - Lista vulnerabilidades")
    print("âœ… /api/vulnerability/upload - Upload de arquivo CSV")
    print()
    print("Para usar no frontend, inclua o token no header:")
    print("Authorization: Bearer <seu_token>")

if __name__ == "__main__":
    main() 