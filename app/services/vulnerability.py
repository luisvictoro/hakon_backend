from typing import List
from fastapi import UploadFile
from sqlalchemy.orm import Session
import pandas as pd
from datetime import datetime

from app import models, schemas


def get_months(db: Session) -> List[str]:
    result = db.query(models.Vulnerability.reference_month).distinct().all()
    return [row[0] for row in result]


def save_csv(db: Session, file: UploadFile, reference_month: str):
    df = pd.read_csv(file.file)
    for _, row in df.iterrows():
        vuln = models.Vulnerability(
            ip=row.get("ip"),
            hostname=row.get("hostname"),
            nvt_name=row.get("nvt_name"),
            severity=row.get("severity"),
            cvss=row.get("cvss"),
            cves=row.get("cves"),
            reference_month=reference_month,
            created_at=datetime.utcnow(),
        )
        db.add(vuln)
    db.commit()


def delete_by_month(db: Session, month: str):
    db.query(models.Vulnerability).filter(models.Vulnerability.reference_month == month).delete()
    db.commit()


def delete_all(db: Session):
    db.query(models.Vulnerability).delete()
    db.commit()


def list_vulnerabilities(db: Session, skip: int = 0, limit: int = 100):
    return db.query(models.Vulnerability).offset(skip).limit(limit).all()
